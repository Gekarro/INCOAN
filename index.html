<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ratios de Gestión del Circulante</title>
    <!-- Chart.js CDN con versión específica -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* Estilos generales */
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f8fafc;
        }
        
        /* Contenedor principal */
        .dashboard {
            display: flex;
            flex-direction: column;
            background: #ffffff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            color: #0F172A;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            border: 1px solid #e2e8f0;
        }
        
        /* Encabezado */
        .header {
            background: #EBF2FF;
            padding: 16px 24px;
            border-radius: 8px;
            margin-bottom: 20px;
            width: 100%;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #0F3460;
            text-align: center;
        }
        
        .header h2 {
            font-size: 18px;
            text-align: center;
            margin: 0 auto;
            font-weight: bold;
            color: #7c3aed;
        }
        
        /* Botones de vista */
        .view-buttons, .filter-buttons, .year-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .view-button {
            padding: 10px 20px;
            margin: 0 10px 20px 10px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            background: white;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            color: #0F172A;
            transition: all 0.3s ease;
            min-width: 130px;
            text-align: center;
        }
        
        .view-button.active {
            border-color: #2563eb;
            background: #2563eb;
            color: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .ratio-button, .year-button {
            padding: 8px 16px;
            margin: 0 8px 16px 0;
            border-radius: 20px;
            border: 2px solid #e2e8f0;
            background: white;
            font-weight: normal;
            font-size: 14px;
            cursor: pointer;
            color: #0F172A;
            transition: all 0.3s ease;
        }
        
        .ratio-button.active, .year-button.active {
            border-color: #7c3aed;
            background: #EBF2FF;
            font-weight: bold;
            color: #7c3aed;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Contenedores de contenido */
        .content-container {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-panel {
            flex: 1 1 550px;
            min-height: 450px;
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
        
        .info-panel {
            flex: 1 1 300px;
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #0F3460;
            text-align: center;
        }
        
        .info-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #0F3460;
            border-bottom: 2px solid #7c3aed;
            padding-bottom: 8px;
        }
        
        /* Contenedor de gráficos - IMPORTANTE para los gráficos */
        .chart-container {
            width: 100%;
            height: 350px;
            position: relative;
            margin: 0 auto;
        }
        
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Tarjeta de información de ratio */
        .ratio-info-card {
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
        }
        
        .ratio-info-card h5 {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .ratio-info-card p {
            font-size: 14px;
            margin: 0 0 8px 0;
        }
        
        /* Tendencias principales */
        .trends-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .trend-item {
            padding: 10px;
            border-radius: 4px;
        }
        
        .trend-item.existencias {
            background: rgba(4, 120, 87, 0.1);
            border-left: 4px solid #10b981;
        }
        
        .trend-item.deudores {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid #f59e0b;
        }
        
        .trend-item.efectivo {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
        }
        
        .trend-item h6 {
            margin: 0 0 5px 0;
            font-size: 15px;
            font-weight: bold;
        }
        
        .trend-item.existencias h6 {
            color: #10b981;
        }
        
        .trend-item.deudores h6 {
            color: #f59e0b;
        }
        
        .trend-item.efectivo h6 {
            color: #3b82f6;
        }
        
        .trend-item p {
            margin: 0;
            font-size: 13px;
        }
        
        /* Componentes del ciclo */
        .cycle-components {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .cycle-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-radius: 4px;
        }
        
        .cycle-item.existencias {
            background: rgba(4, 120, 87, 0.1);
            border-left: 4px solid #10b981;
        }
        
        .cycle-item.deudores {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid #f59e0b;
        }
        
        .cycle-item.pago {
            background: rgba(190, 18, 60, 0.1);
            border-left: 4px solid #be123c;
        }
        
        .cycle-item.ciclo {
            background: rgba(15, 52, 96, 0.1);
            border-left: 4px solid #0F3460;
            font-weight: bold;
        }
        
        .cycle-item span {
            font-size: 14px;
        }
        
        .cycle-item span:first-child {
            font-weight: bold;
        }
        
        /* Hallazgos clave */
        .findings-container {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        .finding-item {
            margin-bottom: 10px;
            position: relative;
            padding-left: 20px;
            font-size: 14px;
        }
        
        .finding-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .finding-item:nth-child(1)::before {
            background: #10b981;
        }
        
        .finding-item:nth-child(2)::before {
            background: #f59e0b;
        }
        
        .finding-item:nth-child(3)::before {
            background: #3b82f6;
        }
        
        .finding-item:nth-child(4)::before {
            background: #e11d48;
        }
        
        /* Pie Components */
        .pie-component {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 6px;
            border-radius: 4px;
        }
        
        .pie-component:nth-child(even) {
            background: rgba(241, 245, 249, 0.5);
        }
        
        .pie-component-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .pie-component-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        .pie-component-values {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 14px;
        }
        
        .pie-component-percentage {
            font-weight: bold;
        }
        
        .pie-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid #e2e8f0;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* Footer */
        .footer {
            background: #EBF2FF;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: #0F172A;
        }
        
        .footer p {
            margin: 0;
            font-weight: 500;
        }
        
        /* Tooltip personalizado */
        .custom-tooltip {
            position: absolute;
            background: white;
            border: 2px solid #2563eb;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            pointer-events: none;
            z-index: 100;
            max-width: 300px;
            display: none;
        }
        
        .tooltip-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 6px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 4px;
        }
        
        .tooltip-row {
            margin: 4px 0;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        
        .tooltip-label {
            font-weight: bold;
        }
        
        .tooltip-context {
            margin-top: 8px;
            padding: 4px 8px;
            background-color: #EBF2FF;
            border-radius: 4px;
            font-size: 13px;
            font-weight: bold;
            color: #7c3aed;
            text-align: center;
        }
        
        /* Media queries */
        @media (max-width: 768px) {
            .dashboard {
                padding: 16px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .header h2 {
                font-size: 16px;
            }
            
            .view-button {
                padding: 8px 16px;
                margin: 0 5px 15px 5px;
                min-width: 110px;
            }
            
            .chart-panel, .info-panel {
                flex: 1 1 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>RATIOS DE GESTIÓN DEL CIRCULANTE</h1>
            <h2>INCOAN (2019-2023)</h2>
        </div>
        
        <div class="view-buttons">
            <button class="view-button active" data-view="lines">TENDENCIAS</button>
            <button class="view-button" data-view="bars">COMPARATIVA</button>
            <button class="view-button" data-view="areas">CICLO EFECTIVO</button>
            <button class="view-button" data-view="pie">COMPOSICIÓN</button>
        </div>
        
        <div class="filter-buttons">
            <button class="ratio-button active" data-ratio="all">TODOS LOS RATIOS</button>
            <button class="ratio-button" data-ratio="existencias">EXISTENCIAS</button>
            <button class="ratio-button" data-ratio="deudores">DEUDORES</button>
            <button class="ratio-button" data-ratio="efectivo">EFECTIVO</button>
            <button class="ratio-button" data-ratio="estructura">ESTRUCTURA AC/ANC</button>
        </div>
        
        <div class="year-buttons" style="display: none;">
            <button class="year-button" data-year="2019">2019</button>
            <button class="year-button" data-year="2020">2020</button>
            <button class="year-button" data-year="2021">2021</button>
            <button class="year-button" data-year="2022">2022</button>
            <button class="year-button active" data-year="2023">2023</button>
        </div>
        
        <div class="content-container">
            <div class="chart-panel">
                <h3 class="chart-title">EVOLUCIÓN DE RATIOS DE GESTIÓN DEL CIRCULANTE</h3>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
            
            <div class="info-panel">
                <h4 class="info-title" id="infoTitle">ANÁLISIS DE RATIOS</h4>
                
                <div id="ratioInfo" style="display: none;" class="ratio-info-card">
                    <h5 id="ratioTitle"></h5>
                    <p><b>Definición:</b> <span id="ratioDefinition"></span></p>
                    <p><b>Evolución:</b> <span id="ratioEvolution"></span></p>
                    <p><b>Interpretación 2023:</b> <span id="ratioInterpretation"></span></p>
                    <p><b>Implicación:</b> <span id="ratioImplication"></span></p>
                </div>
                
                <div id="trendsContainer" class="trends-container">
                    <div class="trend-item existencias">
                        <h6>Existencias/Activo Total</h6>
                        <p>Incremento continuo hasta 2022 (19,9%), seguido de reducción en 2023 (16,3%), reflejando mejor gestión.</p>
                    </div>
                    
                    <div class="trend-item deudores">
                        <h6>Deudores/Activo Total</h6>
                        <p>Notable reducción desde 2020 (33,5%) hasta 2022 (19,3%), con ligera recuperación en 2023 (20,1%).</p>
                    </div>
                    
                    <div class="trend-item efectivo">
                        <h6>Efectivo/Activo Total</h6>
                        <p>Oscilación entre 1,0% y 2,6% durante 2019-2022, seguida de extraordinario incremento en 2023 (10,8%).</p>
                    </div>
                </div>
                
                <div id="cycleContainer" style="display: none;" class="ratio-info-card">
                    <h5>COMPONENTES DEL CICLO</h5>
                    <div class="cycle-components">
                        <div class="cycle-item existencias">
                            <span>Período Medio Almacenamiento:</span>
                            <span>40 días (2023)</span>
                        </div>
                        
                        <div class="cycle-item deudores">
                            <span>Período Medio Cobro:</span>
                            <span>69 días (2023)</span>
                        </div>
                        
                        <div class="cycle-item pago">
                            <span>Período Medio Pago:</span>
                            <span>66 días (2023)</span>
                        </div>
                        
                        <div class="cycle-item ciclo">
                            <span>Ciclo de Efectivo:</span>
                            <span>43 días (2023)</span>
                        </div>
                    </div>
                    
                    <p style="font-size: 14px; margin: 10px 0 0 0;">
                        <b>Evolución del ciclo de efectivo:</b>
                    </p>
                    
                    <ul style="margin: 0 0 10px 0; padding-left: 20px; font-size: 14px;">
                        <li style="margin-bottom: 6px;">2019-2020: <b>Incremento</b> por aumento del PMC</li>
                        <li style="margin-bottom: 6px;">2021-2022: <b>Estabilización</b> por mejor gestión del cobro</li>
                        <li style="margin-bottom: 6px;">2023: <b>Optimización</b> con reducción del PMA</li>
                    </ul>
                    
                    <p style="font-size: 14px; margin: 10px 0 0 0; font-style: italic;">
                        Fórmula: Ciclo de Efectivo = PMC + PMA - PMP
                    </p>
                </div>
                
                <div id="pieContainer" style="display: none;" class="ratio-info-card">
                    <h5>ESTRUCTURA DEL ACTIVO CORRIENTE</h5>
                    <div id="pieComponentsContainer">
                        <!-- Componentes del gráfico de pastel se generarán aquí -->
                    </div>
                    
                    <div class="pie-total">
                        <span>Total Activo Corriente:</span>
                        <span id="pieTotalValue"></span>
                    </div>
                </div>
                
                <div id="pieInfo" style="display: none;" class="ratio-info-card">
                    <h5>EVOLUCIÓN CARACTERÍSTICA</h5>
                    <p id="pieEvolution" style="font-size: 14px; margin: 0 0 10px 0;"></p>
                </div>
                
                <h5 style="font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #2563eb;">
                    <span id="findingsTitle">HALLAZGOS CLAVE</span>
                </h5>
                
                <ul id="findingsContainer" class="findings-container">
                    <li class="finding-item">Reducción significativa del peso de deudores (33,5% → 20,1%)</li>
                    <li class="finding-item">Incremento de existencias hasta 2022 y ajuste en 2023</li>
                    <li class="finding-item">Extraordinario aumento de liquidez en 2023 (10,8%)</li>
                    <li class="finding-item">Optimización progresiva del ciclo de efectivo</li>
                </ul>
            </div>
        </div>
        
        <div class="footer">
            <p id="footerText">
                Los ratios de gestión del circulante muestran una evolución coherente con el modelo de negocio estacional de INCOAN. Destacan la progresiva reducción del peso de deudores comerciales, reflejando mejoras en la gestión de cobros, y el extraordinario incremento de la liquidez en 2023, que sugiere preparación para una nueva fase estratégica.
            </p>
        </div>
        
        <!-- Tooltip personalizado -->
        <div id="customTooltip" class="custom-tooltip">
            <div class="tooltip-title" id="tooltipTitle"></div>
            <div id="tooltipContent"></div>
            <div class="tooltip-context" id="tooltipContext" style="display: none;"></div>
        </div>
    </div>
    
    <script>
        // Opciones de estilo para gráficos
        Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif";
        Chart.defaults.font.size = 12;
        Chart.defaults.color = "#0F172A";
        
        // Colores optimizados para presentaciones con fondo claro
        const colors = {
            background: '#ffffff',
            cardBackground: '#f8fafc',
            headerBackground: '#EBF2FF',
            text: '#0F172A',
            headerText: '#0F3460',
            primary: '#2563eb',
            secondary: '#7c3aed',
            highlight: '#e11d48',
            positive: '#059669',
            neutral: '#f59e0b',
            warning: '#dc2626',
            chartGrid: 'rgba(148, 163, 184, 0.3)',
            cardBorder: '#e2e8f0',
            axisLine: '#334155',
            axisTick: '#334155'
        };
        
        // Colores específicos para cada ratio
        const ratioColors = {
            existencias_activo: '#10b981', // verde para existencias
            deudores_activo: '#f59e0b',   // ámbar para deudores
            efectivo_activo: '#3b82f6',   // azul para efectivo
            ac_anc: '#8b5cf6'             // púrpura para estructura
        };
        
        // Colores para el gráfico de tarta
        const PIE_COLORS = [
            '#10b981', // verde para existencias
            '#f59e0b', // ámbar para deudores
            '#3b82f6', // azul para efectivo
            '#8b5cf6'  // púrpura para otros
        ];
        
        // Datos principales
        const data = [
            { 
                año: '2019', 
                existencias_activo: 9.85, 
                deudores_activo: 30.37,
                efectivo_activo: 2.58,
                ac_anc: 0.86,
                periodo_medio_cobro: 75,
                periodo_medio_pago: 60,
                fondo_maniobra: 232565,
                etiqueta: 'Base'
            },
            { 
                año: '2020', 
                existencias_activo: 12.34, 
                deudores_activo: 33.50,
                efectivo_activo: 1.03,
                ac_anc: 0.88,
                periodo_medio_cobro: 82,
                periodo_medio_pago: 65,
                fondo_maniobra: 310751,
                etiqueta: 'Covid'
            },
            { 
                año: '2021', 
                existencias_activo: 18.49, 
                deudores_activo: 27.16,
                efectivo_activo: 2.38,
                ac_anc: 0.92,
                periodo_medio_cobro: 73,
                periodo_medio_pago: 68,
                fondo_maniobra: 382410,
                etiqueta: 'Recuperación'
            },
            { 
                año: '2022', 
                existencias_activo: 19.91, 
                deudores_activo: 19.27,
                efectivo_activo: 1.64,
                ac_anc: 0.69,
                periodo_medio_cobro: 62,
                periodo_medio_pago: 70,
                fondo_maniobra: 285304,
                etiqueta: 'Inversión'
            },
            { 
                año: '2023', 
                existencias_activo: 16.27, 
                deudores_activo: 20.05,
                efectivo_activo: 10.75,
                ac_anc: 0.89,
                periodo_medio_cobro: 69,
                periodo_medio_pago: 66,
                fondo_maniobra: 712550,
                etiqueta: 'Inflexión'
            }
        ];
        
        // Datos para gráfico de composición de circulante por año
        const pieData = {
            '2019': [
                { name: 'Existencias', value: 419256, percentage: 21.26 },
                { name: 'Deudores', value: 1292790, percentage: 65.55 },
                { name: 'Efectivo', value: 110028, percentage: 5.58 },
                { name: 'Otros AC', value: 150251, percentage: 7.62 }
            ],
            '2020': [
                { name: 'Existencias', value: 584318, percentage: 26.32 },
                { name: 'Deudores', value: 1586252, percentage: 71.46 },
                { name: 'Efectivo', value: 48899, percentage: 2.20 },
                { name: 'Otros AC', value: 209, percentage: 0.01 }
            ],
            '2021': [
                { name: 'Existencias', value: 967393, percentage: 38.50 },
                { name: 'Deudores', value: 1420883, percentage: 56.55 },
                { name: 'Efectivo', value: 124325, percentage: 4.95 },
                { name: 'Otros AC', value: 0, percentage: 0.00 }
            ],
            '2022': [
                { name: 'Existencias', value: 1126342, percentage: 48.78 },
                { name: 'Deudores', value: 1089814, percentage: 47.20 },
                { name: 'Efectivo', value: 92864, percentage: 4.02 },
                { name: 'Otros AC', value: 0, percentage: 0.00 }
            ],
            '2023': [
                { name: 'Existencias', value: 1200094, percentage: 34.56 },
                { name: 'Deudores', value: 1478843, percentage: 42.59 },
                { name: 'Efectivo', value: 792861, percentage: 22.83 },
                { name: 'Otros AC', value: 499, percentage: 0.01 }
            ]
        };
        
        // Datos para análisis del ciclo de efectivo
        const cicloData = [
            { año: '2019', pmc: 75, pmp: 60, ciclo_efectivo: 75 - 60 + 30, pma: 30 },
            { año: '2020', pmc: 82, pmp: 65, ciclo_efectivo: 82 - 65 + 35, pma: 35 },
            { año: '2021', pmc: 73, pmp: 68, ciclo_efectivo: 73 - 68 + 42, pma: 42 },
            { año: '2022', pmc: 62, pmp: 70, ciclo_efectivo: 62 - 70 + 48, pma: 48 },
            { año: '2023', pmc: 69, pmp: 66, ciclo_efectivo: 69 - 66 + 40, pma: 40 }
        ];
        
        // Interpretación de ratios
        const interpretacionRatios = {
            existencias_activo: {
                titulo: "EXISTENCIAS/ACTIVO TOTAL",
                definicion: "Porcentaje del activo total invertido en existencias",
                evolucion: "Incremento continuo hasta 2022 (19,9%), seguido de moderación en 2023 (16,3%)",
                interpretacion2023: "Nivel medio-alto que refleja la importancia del stock para el ciclo estacional navideño",
                implicacion: "Requiere monitoreo de rotación para evitar obsolescencia o deterioro"
            },
            deudores_activo: {
                titulo: "DEUDORES/ACTIVO TOTAL",
                definicion: "Porcentaje del activo total comprometido en crédito a clientes",
                evolucion: "Reducción significativa desde el máximo de 2020 (33,5%) hasta 2022 (19,3%), con ligera recuperación en 2023 (20,1%)",
                interpretacion2023: "Nivel equilibrado que sugiere mejor gestión del crédito comercial",
                implicacion: "Menor tensión financiera por inmovilización de recursos en deudores"
            },
            efectivo_activo: {
                titulo: "EFECTIVO/ACTIVO TOTAL",
                definicion: "Porcentaje del activo total mantenido como liquidez inmediata",
                evolucion: "Niveles conservadores (1-3%) entre 2019-2022, seguidos de extraordinario incremento en 2023 (10,8%)",
                interpretacion2023: "Posición de liquidez muy superior a la histórica y al sector",
                implicacion: "Preparación posible para inversiones o adquisiciones significativas"
            },
            ac_anc: {
                titulo: "ACTIVO CORRIENTE/ACTIVO NO CORRIENTE",
                definicion: "Relación entre inversiones a corto y largo plazo",
                evolucion: "Incremento hasta 2021 (0,92), caída en 2022 (0,69) y recuperación en 2023 (0,89)",
                interpretacion2023: "Equilibrio adecuado entre estructura fija y circulante",
                implicacion: "Refleja adaptación a las necesidades operativas estacionales"
            }
        };
        
        // Hallazgos clave según el ratio seleccionado
        const hallazgos = {
            all: [
                "Reducción significativa del peso de deudores (33,5% → 20,1%)",
                "Incremento de existencias hasta 2022 y ajuste en 2023",
                "Extraordinario aumento de liquidez en 2023 (10,8%)",
                "Optimización progresiva del ciclo de efectivo"
            ],
            existencias: [
                "Incremento continuo hasta 2022 reflejando mayor anticipación a campaña navideña",
                "Estabilización en 2023 con ajuste a niveles más eficientes",
                "Adaptación progresiva a la estacionalidad del negocio",
                "Representa 16,3% del activo total en 2023"
            ],
            deudores: [
                "Reducción sostenida de su peso relativo desde 2020",
                "Cambio estructural en gestión de cobros en 2021-2022",
                "Ligera recuperación en 2023 (20,1%)",
                "Mejora continua en la eficiencia de gestión del crédito comercial"
            ],
            efectivo: [
                "Niveles históricamente conservadores (1-3%) hasta 2022",
                "Extraordinario incremento en 2023 (+557%)",
                "Multiplicación por 6,6 respecto a su peso medio histórico",
                "Posible preparación para expansión o nuevas inversiones"
            ],
            estructura: [
                "Relación AC/ANC refleja equilibrio entre inversiones a corto y largo plazo",
                "Mínimo en 2022 por inversión en activos productivos",
                "Recuperación en 2023 a niveles similares a 2019-2020",
                "Estructura adaptada al ciclo estacional del negocio"
            ]
        };
        
        const pieEvolution = {
            '2019': 'Estructura inicial con claro predominio de deudores comerciales (65,6%), reflejando el largo período de cobro establecido (75 días).',
            '2020': 'Incremento del peso de deudores (71,5%) y reducción drástica del efectivo (2,2%), posiblemente como respuesta a las tensiones de liquidez del entorno COVID.',
            '2021': 'Reequilibrio con incremento significativo de existencias (38,5%), posiblemente anticipando problemas en cadena de suministro post-pandemia.',
            '2022': 'Equilibrio histórico entre existencias (48,8%) y deudores (47,2%), reflejando cambio estructural en la gestión del ciclo operativo.',
            '2023': 'Transformación significativa con extraordinario incremento del efectivo (22,8%), que multiplica por 5,7 su peso relativo respecto al año anterior.'
        };
        
        const pieHallazgos = {
            '2019': [
                "Predominio de deudores refleja dependencia del crédito a clientes",
                "Bajo nivel de existencias (21,3%) indica gestión ajustada",
                "Nivel moderado de efectivo (5,6%)",
                "Estructura adaptada a las necesidades de financiación a clientes"
            ],
            '2020': [
                "Máximo histórico de deudores (71,5%) indica tensión financiera",
                "Incremento de existencias (+39,4%) refleja mayor aprovisionamiento",
                "Mínimo histórico de efectivo (2,2%)",
                "Impacto visible de la situación COVID en el circulante"
            ],
            '2021': [
                "Reequilibrio entre principales componentes",
                "Notable incremento de existencias hasta 38,5%",
                "Reducción del peso de deudores (56,6%)",
                "Recuperación de niveles de efectivo (4,9%)"
            ],
            '2022': [
                "Equilibrio histórico entre existencias y deudores",
                "Máximo peso de existencias (48,8%)",
                "Mínimo peso de deudores (47,2%)",
                "Estructura optimizada para el ciclo estacional"
            ],
            '2023': [
                "Extraordinario incremento del efectivo (22,8%)",
                "Reducción del peso relativo de existencias (34,6%)",
                "Recuperación moderada de deudores (42,6%)",
                "Posible preparación para nueva fase estratégica"
            ]
        };
        
        const cicloHallazgos = [
            "Reducción gradual del ciclo de efectivo desde 2020",
            "Optimización progresiva del PMC desde 82 a 69 días",
            "Incremento estratégico del PMP para mejorar financiación",
            "Gestión eficiente de almacenamiento en 2023 (40 días)"
        ];
        
        const footerTexts = {
            lines: {
                all: "Los ratios de gestión del circulante muestran una evolución coherente con el modelo de negocio estacional de INCOAN. Destacan la progresiva reducción del peso de deudores comerciales, reflejando mejoras en la gestión de cobros, y el extraordinario incremento de la liquidez en 2023, que sugiere preparación para una nueva fase estratégica.",
                existencias: "La evolución del ratio existencias/activo total refleja la adaptación de INCOAN a su ciclo estacional. El incremento hasta 2022 (19,9%) seguido de una moderación en 2023 (16,3%) sugiere una optimización progresiva en la gestión de inventarios para la campaña navideña.",
                deudores: "La reducción sostenida del ratio deudores/activo total desde 2020 (33,5%) hasta 2022 (19,3%), con ligera recuperación en 2023 (20,1%), evidencia una mejora significativa en la gestión del crédito comercial, reduciendo la dependencia financiera de los deudores.",
                efectivo: "El ratio efectivo/activo total muestra un cambio estructural en la posición de liquidez de INCOAN en 2023 (10,8%), multiplicando por más de cinco su nivel histórico (1-3%). Este extraordinario incremento sugiere preparación para inversiones significativas o una nueva fase de desarrollo empresarial.",
                estructura: "La evolución del ratio AC/ANC refleja el equilibrio entre inversiones a corto y largo plazo. La tendencia creciente hasta 2021 (0,92), seguida de caída en 2022 (0,69) y recuperación en 2023 (0,89), muestra la adaptación estructural a las necesidades operativas y estratégicas."
            },
            bars: {
                all: "Los ratios de gestión del circulante muestran una evolución coherente con el modelo de negocio estacional de INCOAN. Destacan la progresiva reducción del peso de deudores comerciales, reflejando mejoras en la gestión de cobros, y el extraordinario incremento de la liquidez en 2023, que sugiere preparación para una nueva fase estratégica.",
                existencias: "La evolución del ratio existencias/activo total refleja la adaptación de INCOAN a su ciclo estacional. El incremento hasta 2022 (19,9%) seguido de una moderación en 2023 (16,3%) sugiere una optimización progresiva en la gestión de inventarios para la campaña navideña.",
                deudores: "La reducción sostenida del ratio deudores/activo total desde 2020 (33,5%) hasta 2022 (19,3%), con ligera recuperación en 2023 (20,1%), evidencia una mejora significativa en la gestión del crédito comercial, reduciendo la dependencia financiera de los deudores.",
                efectivo: "El ratio efectivo/activo total muestra un cambio estructural en la posición de liquidez de INCOAN en 2023 (10,8%), multiplicando por más de cinco su nivel histórico (1-3%). Este extraordinario incremento sugiere preparación para inversiones significativas o una nueva fase de desarrollo empresarial.",
                estructura: "La evolución del ratio AC/ANC refleja el equilibrio entre inversiones a corto y largo plazo. La tendencia creciente hasta 2021 (0,92), seguida de caída en 2022 (0,69) y recuperación en 2023 (0,89), muestra la adaptación estructural a las necesidades operativas y estratégicas."
            },
            areas: "El análisis del ciclo de efectivo muestra la evolución de los períodos medios de cobro, pago y almacenamiento. La optimización progresiva desde 2020 refleja mejoras en la gestión operativa, con un equilibrio adecuado en 2023 (43 días) que reduce las necesidades financieras derivadas del ciclo de negocio estacional.",
            pie: {
                '2019': "La composición del activo corriente en 2019 refleja una estructura inicial con claro predominio de deudores (65,6%), característico de una empresa con ciclo de cobro prolongado.",
                '2020': "La composición del activo corriente en 2020 refleja el impacto de la situación COVID, con máximo histórico de deudores (71,5%) y mínimo de efectivo (2,2%), indicando tensiones financieras.",
                '2021': "La composición del activo corriente en 2021 refleja una fase de reequilibrio, con incremento notable de existencias (38,5%) y reducción del peso de deudores (56,6%), adaptándose al nuevo entorno.",
                '2022': "La composición del activo corriente en 2022 refleja un punto de equilibrio histórico entre existencias (48,8%) y deudores (47,2%), optimizando la estructura para el ciclo estacional.",
                '2023': "La composición del activo corriente en 2023 refleja una transformación significativa, con extraordinario incremento del efectivo (22,8%) que sugiere preparación para una nueva fase estratégica."
            }
        };
        
        // Variables de estado
        let activeView = 'lines';
        let selectedRatio = 'all';
        let selectedYear = '2023';
        let activeChart = null;
        
        // Formateadores de valores
        function formatPercent(value) {
            return `${value.toFixed(1)}%`;
        }
        
        function formatValue(value) {
            if (value < 1) return value.toFixed(2);
            return value.toFixed(1);
        }
        
        function formatEuro(value) {
            return `${new Intl.NumberFormat('es-ES').format(value)} €`;
        }
        
        // Obtener datos filtrados según el ratio seleccionado
        function getFilteredData() {
            if (selectedRatio === 'all') return data;
            
            const dataKeys = {
                'existencias': 'existencias_activo',
                'deudores': 'deudores_activo',
                'efectivo': 'efectivo_activo',
                'estructura': 'ac_anc'
            };
            
            return data.map(item => {
                const filteredItem = {
                    año: item.año,
                    etiqueta: item.etiqueta
                };
                filteredItem[dataKeys[selectedRatio]] = item[dataKeys[selectedRatio]];
                
                return filteredItem;
            });
        }
        
        // Obtener información sobre ratio seleccionado
        function getRatioInfo() {
            const ratioKeys = {
                'existencias': 'existencias_activo',
                'deudores': 'deudores_activo',
                'efectivo': 'efectivo_activo',
                'estructura': 'ac_anc'
            };
            
            return selectedRatio !== 'all' ? interpretacionRatios[ratioKeys[selectedRatio]] : null;
        }
        
        // Inicializar el tooltip personalizado
        const tooltip = document.getElementById('customTooltip');
        const tooltipTitle = document.getElementById('tooltipTitle');
        const tooltipContent = document.getElementById('tooltipContent');
        const tooltipContext = document.getElementById('tooltipContext');
        
        // Mostrar tooltip
        function showTooltip(x, y, title, content, context = null, borderColor = colors.primary) {
            tooltipTitle.textContent = title;
            tooltipContent.innerHTML = content;
            
            if (context) {
                tooltipContext.textContent = context;
                tooltipContext.style.display = 'block';
            } else {
                tooltipContext.style.display = 'none';
            }
            
            tooltip.style.left = `${x}px`;
            tooltip.style.top = `${y}px`;
            tooltip.style.borderColor = borderColor;
            tooltip.style.display = 'block';
        }
        
        // Ocultar tooltip
        function hideTooltip() {
            tooltip.style.display = 'none';
        }
        
        // Crear gráfico de líneas
        function createLineChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const chartTitle = document.querySelector('.chart-title');
            const filteredData = getFilteredData();
            
            // Actualizar título del gráfico
            if (selectedRatio === 'all') {
                chartTitle.textContent = 'EVOLUCIÓN DE RATIOS DE GESTIÓN DEL CIRCULANTE';
            } else {
                const ratioInfo = getRatioInfo();
                chartTitle.textContent = `EVOLUCIÓN RATIO ${ratioInfo.titulo}`;
            }
            
            const datasets = [];
            
            if (selectedRatio === 'all') {
                datasets.push({
                    label: 'Existencias/Activo',
                    data: filteredData.map(item => item.existencias_activo),
                    borderColor: ratioColors.existencias_activo,
                    backgroundColor: 'white',
                    pointBackgroundColor: 'white',
                    pointBorderColor: ratioColors.existencias_activo,
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    borderWidth: 3,
                    tension: 0.1
                });
                
                datasets.push({
                    label: 'Deudores/Activo',
                    data: filteredData.map(item => item.deudores_activo),
                    borderColor: ratioColors.deudores_activo,
                    backgroundColor: 'white',
                    pointBackgroundColor: 'white',
                    pointBorderColor: ratioColors.deudores_activo,
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    borderWidth: 3,
                    tension: 0.1
                });
                
                datasets.push({
                    label: 'Efectivo/Activo',
                    data: filteredData.map(item => item.efectivo_activo),
                    borderColor: ratioColors.efectivo_activo,
                    backgroundColor: 'white',
                    pointBackgroundColor: 'white',
                    pointBorderColor: ratioColors.efectivo_activo,
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    borderWidth: 3,
                    tension: 0.1
                });
                
                datasets.push({
                    label: 'AC/ANC',
                    data: filteredData.map(item => item.ac_anc),
                    borderColor: ratioColors.ac_anc,
                    backgroundColor: 'white',
                    pointBackgroundColor: 'white',
                    pointBorderColor: ratioColors.ac_anc,
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    borderWidth: 3,
                    tension: 0.1,
                    borderDash: [5, 5]
                });
            } else {
                const dataKeys = {
                    'existencias': 'existencias_activo',
                    'deudores': 'deudores_activo',
                    'efectivo': 'efectivo_activo',
                    'estructura': 'ac_anc'
                };
                
                const ratioLabels = {
                    'existencias': 'Existencias/Activo',
                    'deudores': 'Deudores/Activo',
                    'efectivo': 'Efectivo/Activo',
                    'estructura': 'AC/ANC'
                };
                
                datasets.push({
                    label: ratioLabels[selectedRatio],
                    data: filteredData.map(item => item[dataKeys[selectedRatio]]),
                    borderColor: ratioColors[dataKeys[selectedRatio]],
                    backgroundColor: 'white',
                    pointBackgroundColor: 'white',
                    pointBorderColor: ratioColors[dataKeys[selectedRatio]],
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    borderWidth: 3,
                    tension: 0.1
                });
            }
            
            // Si ya existe un gráfico, destruirlo
            if (activeChart) {
                activeChart.destroy();
            }
            
            activeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredData.map(item => item.año),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: colors.chartGrid
                            },
                            ticks: {
                                color: colors.axisLine,
                                font: {
                                    weight: 'bold'
                                }
                            },
                            border: {
                                color: colors.axisLine
                            }
                        },
                        x: {
                            grid: {
                                color: colors.chartGrid
                            },
                            ticks: {
                                color: colors.axisLine,
                                font: {
                                    weight: 'bold'
                                }
                            },
                            border: {
                                color: colors.axisLine
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipModel = context.tooltip;
                                
                                // Ocultar si no hay datos
                                if (tooltipModel.opacity === 0) {
                                    hideTooltip();
                                    return;
                                }
                                
                                const dataIndex = tooltipModel.dataPoints[0].dataIndex;
                                const item = filteredData[dataIndex];
                                const año = item.año;
                                
                                let content = '';
                                
                                tooltipModel.dataPoints.forEach(point => {
                                    const datasetLabel = point.dataset.label;
                                    const value = point.raw;
                                    const color = point.dataset.borderColor;
                                    
                                    const formattedValue = datasetLabel.includes('Activo') ? 
                                        formatPercent(value) : formatValue(value);
                                    
                                    content += `
                                    <div class="tooltip-row">
                                        <span class="tooltip-label" style="color: ${color}">${datasetLabel}:</span>
                                        <span>${formattedValue}</span>
                                    </div>`;
                                });
                                
                                // Añadir etiqueta de contexto si existe
                                const etiqueta = item.etiqueta ? item.etiqueta : null;
                                
                                // Mostrar tooltip
                                const position = context.chart.canvas.getBoundingClientRect();
                                
                                // Considerar el scroll de la página
                                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                                const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                                
                                showTooltip(
                                    position.left + scrollLeft + tooltipModel.caretX,
                                    position.top + scrollTop + tooltipModel.caretY,
                                    año,
                                    content,
                                    etiqueta
                                );
                            }
                        }
                    }
                }
            });
        }
        
        // Crear gráfico de barras
        function createBarChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const chartTitle = document.querySelector('.chart-title');
            const filteredData = getFilteredData();
            
            // Actualizar título del gráfico
            if (selectedRatio === 'all') {
                chartTitle.textContent = 'COMPARATIVA DE RATIOS POR AÑO';
            } else {
                const ratioInfo = getRatioInfo();
                chartTitle.textContent = `COMPARATIVA ANUAL ${ratioInfo.titulo}`;
            }
            
            const datasets = [];
            
            if (selectedRatio === 'all') {
                datasets.push({
                    label: 'Existencias/Activo',
                    data: filteredData.map(item => item.existencias_activo),
                    backgroundColor: ratioColors.existencias_activo,
                    borderColor: ratioColors.existencias_activo,
                    borderWidth: 1
                });
                
                datasets.push({
                    label: 'Deudores/Activo',
                    data: filteredData.map(item => item.deudores_activo),
                    backgroundColor: ratioColors.deudores_activo,
                    borderColor: ratioColors.deudores_activo,
                    borderWidth: 1
                });
                
                datasets.push({
                    label: 'Efectivo/Activo',
                    data: filteredData.map(item => item.efectivo_activo),
                    backgroundColor: ratioColors.efectivo_activo,
                    borderColor: ratioColors.efectivo_activo,
                    borderWidth: 1
                });
            } else {
                const dataKeys = {
                    'existencias': 'existencias_activo',
                    'deudores': 'deudores_activo',
                    'efectivo': 'efectivo_activo',
                    'estructura': 'ac_anc'
                };
                
                const ratioLabels = {
                    'existencias': 'Existencias/Activo',
                    'deudores': 'Deudores/Activo',
                    'efectivo': 'Efectivo/Activo',
                    'estructura': 'AC/ANC'
                };
                
                datasets.push({
                    label: ratioLabels[selectedRatio],
                    data: filteredData.map(item => item[dataKeys[selectedRatio]]),
                    backgroundColor: ratioColors[dataKeys[selectedRatio]],
                    borderColor: ratioColors[dataKeys[selectedRatio]],
                    borderWidth: 1
                });
            }
            
            // Si ya existe un gráfico, destruirlo
            if (activeChart) {
                activeChart.destroy();
            }
            
            activeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: filteredData.map(item => item.año),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: colors.chartGrid
                            },
                            ticks: {
                                color: colors.axisLine,
                                font: {
                                    weight: 'bold'
                                }
                            },
                            border: {
                                color: colors.axisLine
                            }
                        },
                        x: {
                            grid: {
                                color: colors.chartGrid
                            },
                            ticks: {
                                color: colors.axisLine,
                                font: {
                                    weight: 'bold'
                                }
                            },
                            border: {
                                color: colors.axisLine
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipModel = context.tooltip;
                                
                                // Ocultar si no hay datos
                                if (tooltipModel.opacity === 0) {
                                    hideTooltip();
                                    return;
                                }
                                
                                const dataIndex = tooltipModel.dataPoints[0].dataIndex;
                                const item = filteredData[dataIndex];
                                const año = item.año;
                                
                                let content = '';
                                
                                tooltipModel.dataPoints.forEach(point => {
                                    const datasetLabel = point.dataset.label;
                                    const value = point.raw;
                                    const color = point.dataset.borderColor;
                                    
                                    const formattedValue = datasetLabel.includes('Activo') ? 
                                        formatPercent(value) : formatValue(value);
                                    
                                    content += `
                                    <div class="tooltip-row">
                                        <span class="tooltip-label" style="color: ${color}">${datasetLabel}:</span>
                                        <span>${formattedValue}</span>
                                    </div>`;
                                });
                                
                                // Añadir etiqueta de contexto si existe
                                const etiqueta = item.etiqueta ? item.etiqueta : null;
                                
                                // Mostrar tooltip
                                const position = context.chart.canvas.getBoundingClientRect();
                                
                                // Considerar el scroll de la página
                                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                                const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                                
                                showTooltip(
                                    position.left + scrollLeft + tooltipModel.caretX,
                                    position.top + scrollTop + tooltipModel.caretY,
                                    año,
                                    content,
                                    etiqueta
                                );
                            }
                        }
                    }
                }
            });
        }
        
        // Crear gráfico de áreas
        function createAreaChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const chartTitle = document.querySelector('.chart-title');
            
            // Actualizar título del gráfico
            chartTitle.textContent = 'EVOLUCIÓN DEL CICLO DE EFECTIVO (DÍAS)';
            
            // Si ya existe un gráfico, destruirlo
            if (activeChart) {
                activeChart.destroy();
            }
            
            activeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: cicloData.map(item => item.año),
                    datasets: [
                        {
                            label: 'Período Medio Cobro',
                            data: cicloData.map(item => item.pmc),
                            fill: true,
                            backgroundColor: `${ratioColors.deudores_activo}30`,
                            borderColor: ratioColors.deudores_activo,
                            tension: 0.1,
                            borderWidth: 2
                        },
                        {
                            label: 'Período Medio Almacenamiento',
                            data: cicloData.map(item => item.pma),
                            fill: true,
                            backgroundColor: `${ratioColors.existencias_activo}30`,
                            borderColor: ratioColors.existencias_activo,
                            tension: 0.1,
                            borderWidth: 2
                        },
                        {
                            label: 'Período Medio Pago',
                            data: cicloData.map(item => item.pmp),
                            fill: true,
                            backgroundColor: `#be123c30`,
                            borderColor: '#be123c',
                            tension: 0.1,
                            borderWidth: 2
                        },
                        {
                            label: 'Ciclo de Efectivo',
                            data: cicloData.map(item => item.ciclo_efectivo),
                            fill: false,
                            borderColor: colors.headerText,
                            tension: 0.1,
                            borderWidth: 3,
                            pointBackgroundColor: 'white',
                            pointBorderColor: colors.headerText,
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: colors.chartGrid
                            },
                            ticks: {
                                color: colors.axisLine,
                                font: {
                                    weight: 'bold'
                                }
                            },
                            border: {
                                color: colors.axisLine
                            },
                            title: {
                                display: true,
                                text: 'DÍAS',
                                color: colors.axisLine,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: colors.chartGrid
                            },
                            ticks: {
                                color: colors.axisLine,
                                font: {
                                    weight: 'bold'
                                }
                            },
                            border: {
                                color: colors.axisLine
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipModel = context.tooltip;
                                
                                // Ocultar si no hay datos
                                if (tooltipModel.opacity === 0) {
                                    hideTooltip();
                                    return;
                                }
                                
                                const dataIndex = tooltipModel.dataPoints[0].dataIndex;
                                const year = cicloData[dataIndex].año;
                                
                                let content = '';
                                
                                tooltipModel.dataPoints.forEach(point => {
                                    const datasetLabel = point.dataset.label;
                                    const value = point.raw;
                                    const color = point.dataset.borderColor;
                                    
                                    content += `
                                    <div class="tooltip-row">
                                        <span class="tooltip-label" style="color: ${color}">${datasetLabel}:</span>
                                        <span>${value} días</span>
                                    </div>`;
                                });
                                
                                // Mostrar tooltip
                                const position = context.chart.canvas.getBoundingClientRect();
                                
                                // Considerar el scroll de la página
                                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                                const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                                
                                showTooltip(
                                    position.left + scrollLeft + tooltipModel.caretX,
                                    position.top + scrollTop + tooltipModel.caretY,
                                    year,
                                    content
                                );
                            }
                        }
                    }
                }
            });
        }
        
        // Crear gráfico de pastel
        function createPieChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const chartTitle = document.querySelector('.chart-title');
            const yearData = pieData[selectedYear];
            
            // Actualizar título del gráfico
            chartTitle.textContent = `COMPOSICIÓN DEL ACTIVO CORRIENTE (${selectedYear})`;
            
            // Si ya existe un gráfico, destruirlo
            if (activeChart) {
                activeChart.destroy();
            }
            
            activeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: yearData.map(item => item.name),
                    datasets: [{
                        data: yearData.map(item => item.value),
                        backgroundColor: PIE_COLORS,
                        borderColor: colors.background,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: 20,
                                color: colors.text
                            }
                        },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltipModel = context.tooltip;
                                
                                // Ocultar si no hay datos
                                if (tooltipModel.opacity === 0) {
                                    hideTooltip();
                                    return;
                                }
                                
                                const dataIndex = tooltipModel.dataPoints[0].dataIndex;
                                const item = yearData[dataIndex];
                                
                                let content = `
                                <p style="margin: 0; font-size: 14px;"><b>Valor:</b> ${formatEuro(item.value)}</p>
                                <p style="margin: 0; font-size: 14px;"><b>Porcentaje:</b> ${formatPercent(item.percentage)}</p>`;
                                
                                // Mostrar tooltip
                                const position = context.chart.canvas.getBoundingClientRect();
                                
                                // Considerar el scroll de la página
                                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                                const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                                
                                showTooltip(
                                    position.left + scrollLeft + tooltipModel.caretX,
                                    position.top + scrollTop + tooltipModel.caretY,
                                    item.name,
                                    content,
                                    null,
                                    PIE_COLORS[dataIndex]
                                );
                            }
                        }
                    }
                }
            });
            
            // Actualizar componentes del gráfico de pastel en el panel de información
            updatePieComponents();
        }
        
        // Actualizar componentes del gráfico de pastel
        function updatePieComponents() {
            const pieComponentsContainer = document.getElementById('pieComponentsContainer');
            const pieTotalValue = document.getElementById('pieTotalValue');
            const yearData = pieData[selectedYear];
            
            // Limpiar contenedor
            pieComponentsContainer.innerHTML = '';
            
            // Añadir componentes
            yearData.forEach((item, index) => {
                const componentEl = document.createElement('div');
                componentEl.className = 'pie-component';
                
                const nameEl = document.createElement('div');
                nameEl.className = 'pie-component-name';
                
                const colorEl = document.createElement('div');
                colorEl.className = 'pie-component-color';
                colorEl.style.backgroundColor = PIE_COLORS[index];
                
                nameEl.appendChild(colorEl);
                nameEl.appendChild(document.createTextNode(`${item.name}:`));
                
                const valuesEl = document.createElement('div');
                valuesEl.className = 'pie-component-values';
                
                const valueEl = document.createElement('span');
                valueEl.textContent = formatEuro(item.value);
                
                const percentageEl = document.createElement('span');
                percentageEl.className = 'pie-component-percentage';
                percentageEl.textContent = formatPercent(item.percentage);
                
                if (item.percentage > 30) {
                    percentageEl.style.color = colors.highlight;
                } else if (item.percentage > 20) {
                    percentageEl.style.color = colors.neutral;
                } else {
                    percentageEl.style.color = colors.positive;
                }
                
                valuesEl.appendChild(valueEl);
                valuesEl.appendChild(percentageEl);
                
                componentEl.appendChild(nameEl);
                componentEl.appendChild(valuesEl);
                
                pieComponentsContainer.appendChild(componentEl);
            });
            
            // Actualizar valor total
            const totalValue = yearData.reduce((sum, item) => sum + item.value, 0);
            pieTotalValue.textContent = formatEuro(totalValue);
            
            // Actualizar evolución característica
            document.getElementById('pieEvolution').textContent = pieEvolution[selectedYear];
        }
        
        // Actualizar información de ratio seleccionado
        function updateRatioInfo() {
            const ratioInfo = getRatioInfo();
            const ratioInfoEl = document.getElementById('ratioInfo');
            
            if (selectedRatio !== 'all' && (activeView === 'lines' || activeView === 'bars')) {
                const titleEl = document.getElementById('ratioTitle');
                const definitionEl = document.getElementById('ratioDefinition');
                const evolutionEl = document.getElementById('ratioEvolution');
                const interpretationEl = document.getElementById('ratioInterpretation');
                const implicationEl = document.getElementById('ratioImplication');
                
                titleEl.textContent = ratioInfo.titulo;
                definitionEl.textContent = ratioInfo.definicion;
                evolutionEl.textContent = ratioInfo.evolucion;
                interpretationEl.textContent = ratioInfo.interpretacion2023;
                implicationEl.textContent = ratioInfo.implicacion;
                
                // Cambiar color del título según el ratio
                if (selectedRatio === 'existencias') {
                    titleEl.style.color = ratioColors.existencias_activo;
                } else if (selectedRatio === 'deudores') {
                    titleEl.style.color = ratioColors.deudores_activo;
                } else if (selectedRatio === 'efectivo') {
                    titleEl.style.color = ratioColors.efectivo_activo;
                } else {
                    titleEl.style.color = ratioColors.ac_anc;
                }
                
                ratioInfoEl.style.display = 'block';
            } else {
                ratioInfoEl.style.display = 'none';
            }
        }
        
        // Actualizar hallazgos clave
        function updateFindings() {
            const findingsContainer = document.getElementById('findingsContainer');
            const findingsTitle = document.getElementById('findingsTitle');
            
            findingsContainer.innerHTML = '';
            
            let currentHallazgos = [];
            
            if (activeView === 'pie') {
                findingsTitle.textContent = `HALLAZGOS CLAVE ${selectedYear}`;
                currentHallazgos = pieHallazgos[selectedYear];
            } else if (activeView === 'areas') {
                findingsTitle.textContent = 'IMPLICACIONES DEL CICLO';
                currentHallazgos = cicloHallazgos;
            } else {
                findingsTitle.textContent = 'HALLAZGOS CLAVE';
                currentHallazgos = hallazgos[selectedRatio];
            }
            
            currentHallazgos.forEach((finding, index) => {
                const findingEl = document.createElement('li');
                findingEl.className = 'finding-item';
                findingEl.textContent = finding;
                findingsContainer.appendChild(findingEl);
            });
        }
        
        // Actualizar texto del footer
        function updateFooterText() {
            const footerTextEl = document.getElementById('footerText');
            
            if (activeView === 'areas') {
                footerTextEl.textContent = footerTexts.areas;
            } else if (activeView === 'pie') {
                footerTextEl.textContent = footerTexts.pie[selectedYear];
            } else {
                footerTextEl.textContent = footerTexts[activeView][selectedRatio];
            }
        }
        
        // Actualizar panel de información
        function updateInfoPanel() {
            const infoTitle = document.getElementById('infoTitle');
            const trendsContainer = document.getElementById('trendsContainer');
            const cycleContainer = document.getElementById('cycleContainer');
            const pieContainer = document.getElementById('pieContainer');
            const pieInfo = document.getElementById('pieInfo');
            
            // Ocultar todos los contenedores primero
            trendsContainer.style.display = 'none';
            cycleContainer.style.display = 'none';
            pieContainer.style.display = 'none';
            pieInfo.style.display = 'none';
            
            // Actualizar título y mostrar contenedor correspondiente
            if (activeView === 'pie') {
                infoTitle.textContent = `ANÁLISIS COMPOSICIÓN ${selectedYear}`;
                pieContainer.style.display = 'block';
                pieInfo.style.display = 'block';
            } else if (activeView === 'areas') {
                infoTitle.textContent = 'ANÁLISIS CICLO DE EFECTIVO';
                cycleContainer.style.display = 'block';
            } else {
                if (selectedRatio === 'all') {
                    infoTitle.textContent = 'ANÁLISIS DE RATIOS';
                    trendsContainer.style.display = 'flex';
                } else {
                    const ratioInfo = getRatioInfo();
                    infoTitle.textContent = `ANÁLISIS ${ratioInfo.titulo}`;
                }
            }
            
            updateRatioInfo();
            updateFindings();
            updateFooterText();
        }
        
        // Función para actualizar los controles visibles
        function updateControls() {
            const filterButtons = document.querySelector('.filter-buttons');
            const yearButtons = document.querySelector('.year-buttons');
            
            if (activeView === 'pie') {
                filterButtons.style.display = 'none';
                yearButtons.style.display = 'flex';
            } else {
                yearButtons.style.display = 'none';
                
                if (activeView === 'areas') {
                    filterButtons.style.display = 'none';
                } else {
                    filterButtons.style.display = 'flex';
                }
            }
        }
        
        // Función principal para actualizar la vista
        function updateView() {
            // Actualizar controles
            updateControls();
            
            // Crear gráfico según la vista activa
            if (activeView === 'lines') {
                createLineChart();
            } else if (activeView === 'bars') {
                createBarChart();
            } else if (activeView === 'areas') {
                createAreaChart();
            } else if (activeView === 'pie') {
                createPieChart();
            }
            
            // Actualizar panel de información
            updateInfoPanel();
        }
        
        // Event listeners para botones de vista
        document.querySelectorAll('.view-button').forEach(button => {
            button.addEventListener('click', function() {
                // Remover clase active de todos los botones
                document.querySelectorAll('.view-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Añadir clase active al botón clickeado
                this.classList.add('active');
                
                // Actualizar vista activa
                activeView = this.dataset.view;
                
                // Actualizar vista
                updateView();
            });
        });
        
        // Event listeners para botones de ratio
        document.querySelectorAll('.ratio-button').forEach(button => {
            button.addEventListener('click', function() {
                // Remover clase active de todos los botones
                document.querySelectorAll('.ratio-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Añadir clase active al botón clickeado
                this.classList.add('active');
                
                // Actualizar ratio seleccionado
                selectedRatio = this.dataset.ratio;
                
                // Actualizar vista
                updateView();
            });
        });
        
        // Event listeners para botones de año
        document.querySelectorAll('.year-button').forEach(button => {
            button.addEventListener('click', function() {
                // Remover clase active de todos los botones
                document.querySelectorAll('.year-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Añadir clase active al botón clickeado
                this.classList.add('active');
                
                // Actualizar año seleccionado
                selectedYear = this.dataset.year;
                
                // Actualizar vista
                updateView();
            });
        });
        
        // Inicializar vista después de que cargue todo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, inicializando gráfico...');
            updateView();
        });
        
        // Inicializar vista inmediatamente para navegadores que no disparan DOMContentLoaded
        try {
            updateView();
        } catch (e) {
            console.error('Error al inicializar vista:', e);
        }
    </script>
</body>
</html>